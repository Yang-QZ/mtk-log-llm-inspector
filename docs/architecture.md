# Audio Dump Automation System - 架构设计

## 概述

Audio Dump自动化监控系统用于解决Android设备音频dump文件的自动采集问题。系统分为两个主要部分：

1. **Android HAL端 (C++)**: 在设备上运行，管理音频dump文件的创建和通知
2. **Windows监控端 (Python)**: 在PC上运行，监听通知并自动拉取文件

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Android Device                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                        Audio HAL Layer                               │    │
│  │  ┌─────────────────┐     ┌─────────────────┐                        │    │
│  │  │   StreamOut     │     │    StreamIn     │                        │    │
│  │  │   (播放流)      │     │    (录音流)     │                        │    │
│  │  └────────┬────────┘     └────────┬────────┘                        │    │
│  │           │                       │                                  │    │
│  │           │ WriteData()           │ WriteData()                      │    │
│  │           ▼                       ▼                                  │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │                     StreamDumper                             │    │    │
│  │  │  • 256KB 写入缓冲区                                          │    │    │
│  │  │  • 每10MB flush一次                                          │    │    │
│  │  │  • 100MB自动切换文件                                         │    │    │
│  │  │  • .tmp后缀写入，完成后重命名                                │    │    │
│  │  └──────────────────────┬──────────────────────────────────────┘    │    │
│  │                         │ OnDumpFileCompleted()                      │    │
│  │                         ▼                                            │    │
│  │  ┌─────────────────────────────────────────────────────────────┐    │    │
│  │  │                  AudioDumpManager (Singleton)                │    │    │
│  │  │  • 监听系统属性 vendor.streamout/streamin.pcm.dump           │    │    │
│  │  │  • 管理dump目录 /data/vendor/audio_dump/                     │    │    │
│  │  │  • 维护完成文件队列                                          │    │    │
│  │  │  • 通过logcat发送 AUDIO_DUMP_READY 通知                      │    │    │
│  │  │  • 写入 .queue 文件                                          │    │    │
│  │  └──────────┬──────────────────────────────────────────────────┘    │    │
│  │             │                                                        │    │
│  └─────────────┼────────────────────────────────────────────────────────┘    │
│                │                                                              │
│                ▼                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     /data/vendor/audio_dump/                         │    │
│  │  ┌───────────────────────────────────────────────────────────────┐  │    │
│  │  │  audio_streamout_20240106_103000_0_1.pcm                      │  │    │
│  │  │  audio_streamout_20240106_103000_0_2.pcm                      │  │    │
│  │  │  audio_streamin_20240106_103005_1_1.pcm                       │  │    │
│  │  │  .queue (文件名列表)                                          │  │    │
│  │  └───────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│                ║                                                             │
│                ║ Logcat: "AUDIO_DUMP_READY: filename"                        │
│                ║                                                             │
└────────────────╬─────────────────────────────────────────────────────────────┘
                 ║
                 ║ ADB (USB/WiFi)
                 ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              Windows PC                                      │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     AudioDumpMonitor (Python)                        │    │
│  │                                                                      │    │
│  │  ┌───────────────────┐   ┌───────────────────┐                      │    │
│  │  │ LogcatListener    │   │   QueuePoller     │                      │    │
│  │  │ (实时监听线程)    │   │  (每10秒轮询)     │                      │    │
│  │  └─────────┬─────────┘   └─────────┬─────────┘                      │    │
│  │            │                       │                                 │    │
│  │            └───────────┬───────────┘                                 │    │
│  │                        ▼                                             │    │
│  │            ┌─────────────────────────┐                               │    │
│  │            │     Task Queue          │                               │    │
│  │            │  (queue.Queue)          │                               │    │
│  │            └───────────┬─────────────┘                               │    │
│  │                        │                                             │    │
│  │            ┌───────────┼───────────┐                                 │    │
│  │            ▼           ▼           ▼                                 │    │
│  │  ┌─────────────┐ ┌─────────────┐                                     │    │
│  │  │PullWorker 0 │ │PullWorker 1 │ ... (可配置数量)                    │    │
│  │  └──────┬──────┘ └──────┬──────┘                                     │    │
│  │         │               │                                            │    │
│  │         └───────┬───────┘                                            │    │
│  │                 ▼                                                    │    │
│  │    ┌─────────────────────────────────┐                               │    │
│  │    │       pull_and_delete()         │                               │    │
│  │    │  1. adb pull device_file local  │                               │    │
│  │    │  2. adb shell rm device_file    │                               │    │
│  │    │  3. 更新 .queue 文件            │                               │    │
│  │    └─────────────────────────────────┘                               │    │
│  │                                                                      │    │
│  │  ┌───────────────────┐   ┌───────────────────┐                      │    │
│  │  │  StatsReporter    │   │    Statistics     │                      │    │
│  │  │ (每60秒报告)      │   │  (统计信息)       │                      │    │
│  │  └───────────────────┘   └───────────────────┘                      │    │
│  │                                                                      │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                     ./audio_dumps/                                   │    │
│  │  ┌───────────────────────────────────────────────────────────────┐  │    │
│  │  │  audio_streamout_20240106_103000_0_1.pcm                      │  │    │
│  │  │  audio_streamout_20240106_103000_0_2.pcm                      │  │    │
│  │  │  audio_streamin_20240106_103005_1_1.pcm                       │  │    │
│  │  └───────────────────────────────────────────────────────────────┘  │    │
│  └─────────────────────────────────────────────────────────────────────┘    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

## 数据流程

### 1. Dump文件创建流程

```
┌────────────────┐     ┌─────────────────┐     ┌──────────────────┐
│  Audio Stream  │────▶│  StreamDumper   │────▶│  Dump File       │
│  (PCM Data)    │     │  (Buffer/Write) │     │  (.tmp → .pcm)   │
└────────────────┘     └────────┬────────┘     └──────────────────┘
                                │
                                │ OnDumpFileCompleted()
                                ▼
                       ┌─────────────────┐
                       │ AudioDumpManager│
                       └────────┬────────┘
                                │
                    ┌───────────┼───────────┐
                    ▼           ▼           ▼
            ┌──────────┐ ┌──────────┐ ┌──────────┐
            │  Memory  │ │  .queue  │ │  Logcat  │
            │  Queue   │ │   File   │ │ ALOGI()  │
            └──────────┘ └──────────┘ └──────────┘
```

### 2. 文件拉取流程

```
┌──────────────────────────────────────────────────────────────────┐
│                       Windows Monitor                             │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│   ┌─────────────────┐         ┌─────────────────┐                │
│   │ Logcat Listener │         │  Queue Poller   │                │
│   │ (实时)          │         │  (每10秒)       │                │
│   └────────┬────────┘         └────────┬────────┘                │
│            │ 匹配正则:                  │ 读取文件:              │
│            │ AUDIO_DUMP_READY: (\S+)   │ cat .queue             │
│            │                           │                         │
│            └───────────┬───────────────┘                         │
│                        │                                          │
│                        │ 新文件?                                  │
│                        │ (Set去重)                                │
│                        ▼                                          │
│               ┌─────────────────┐                                 │
│               │   Task Queue    │                                 │
│               └────────┬────────┘                                 │
│                        │                                          │
│                        ▼                                          │
│               ┌─────────────────┐                                 │
│               │  Pull Workers   │─────┐                           │
│               └────────┬────────┘     │                           │
│                        │              │ 重试                      │
│                        ▼              │ (max 3次)                 │
│           ┌────────────────────────┐  │                           │
│           │    pull_and_delete()   │◀─┘                           │
│           │  1. adb pull file      │                              │
│           │  2. 验证文件           │                              │
│           │  3. adb shell rm       │                              │
│           │  4. sed -i 更新.queue  │                              │
│           └────────────┬───────────┘                              │
│                        │                                          │
│            ┌───────────┴───────────┐                              │
│            ▼                       ▼                              │
│     ┌──────────────┐       ┌──────────────┐                       │
│     │ 成功: 更新   │       │ 失败: 记录   │                       │
│     │ Statistics   │       │ 错误日志     │                       │
│     └──────────────┘       └──────────────┘                       │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

## 组件详解

### Android HAL端组件

#### AudioDumpManager

单例模式的核心管理器，负责：

- 监听系统属性 `vendor.streamout.pcm.dump` 和 `vendor.streamin.pcm.dump`
- 管理dump目录的创建和权限
- 为每个音频流创建StreamDumper实例
- 维护完成文件队列（内存队列 + .queue文件）
- 通过logcat发送AUDIO_DUMP_READY通知

#### StreamDumper

单个音频流的dump处理器，特性：

- **文件命名**: `audio_{streamout/streamin}_{timestamp}_{counter}_{index}.pcm`
- **临时文件**: 写入时使用`.tmp`后缀，完成后重命名
- **自动切换**: 达到100MB时关闭当前文件，创建新文件
- **IO优化**: 256KB缓冲区，每10MB flush一次
- **线程安全**: 所有操作使用mutex保护

### Windows监控端组件

#### Config

配置管理类，支持：

- JSON配置文件加载
- 默认值设置
- 属性访问方式获取配置

#### Statistics

统计信息跟踪器：

- 已拉取文件数
- 失败次数
- 总传输字节数
- 运行时间
- 平均速度计算

#### AudioDumpMonitor

主监控类，管理多个工作线程：

1. **LogcatListener**: 实时监听logcat输出
2. **QueuePoller**: 定期轮询.queue文件
3. **PullWorkers**: 并发拉取文件（默认2个线程）
4. **StatsReporter**: 定期报告统计信息

## 线程安全

### Android端

- `AudioDumpManager::mMutex` 保护文件队列和计数器
- `StreamDumper::mMutex` 保护文件写入操作
- 使用 `std::atomic` 管理文件计数器

### Windows端

- `queue.Queue` 本身是线程安全的
- `threading.Lock` 保护 `processed_files` 集合
- `Statistics` 类使用锁保护统计数据

## 错误处理

### Android端

- 文件创建失败时返回nullptr
- 写入失败时设置Invalid状态
- 磁盘满时自动关闭当前文件
- 不完整的dump文件会被删除

### Windows端

- ADB连接断开时自动重试
- 文件拉取失败时重试（最多3次）
- 异常捕获和日志记录
- 优雅的关机处理

## 性能优化

### Android端

- 256KB写入缓冲区减少系统调用
- 每10MB flush一次减少磁盘IO
- 100MB自动切换避免单文件过大

### Windows端

- 多线程并发拉取
- 使用Set防止重复处理
- logcat实时通知避免轮询延迟
- 队列轮询作为备份机制
